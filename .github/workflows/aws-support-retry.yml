name: AWS Support Request Auto-Retry

# ãƒ¬ãƒ¼ãƒˆåˆ¶é™è§£é™¤å¾Œã®è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
# 30åˆ†ã”ã¨ã«å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å†å®Ÿè¡Œã—ã¾ã™

on:
  # 30åˆ†ã”ã¨ã«å®Ÿè¡Œ
  schedule:
    - cron: '*/30 * * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issueç•ªå·ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³: æŒ‡å®šã—ãªã„å ´åˆã¯å…¨ã¦ã®å¤±æ•—Issueã‚’å†è©¦è¡Œï¼‰'
        required: false
        type: string

jobs:
  check-and-retry:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find failed workflows and retry
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = '${{ github.event.inputs.issue_number }}';

            // éå»24æ™‚é–“ä»¥å†…ã®å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å–å¾—
            const workflows = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              status: 'failure',
              created: `>=${new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()}`,
              per_page: 100
            });

            console.log(`Found ${workflows.data.workflow_runs.length} failed workflows in the last 24 hours`);

            // AWS Support Auto-Generatorãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
            const targetWorkflows = workflows.data.workflow_runs.filter(run =>
              run.name === 'AWS Support Request Auto-Generator (MVP)' &&
              run.conclusion === 'failure'
            );

            console.log(`Found ${targetWorkflows.length} failed AWS Support workflows`);

            if (targetWorkflows.length === 0) {
              console.log('No failed workflows to retry. Exiting.');
              return;
            }

            // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ­ã‚°ã‹ã‚‰åˆ¤å®šï¼‰
            for (const workflow of targetWorkflows) {
              // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ­ã‚°ã‚’å–å¾—ï¼ˆç°¡æ˜“ç‰ˆ: å†å®Ÿè¡Œã‚’è©¦ã¿ã‚‹ï¼‰
              const jobs = await github.rest.actions.listJobsForWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: workflow.id
              });

              console.log(`Workflow #${workflow.id}: ${jobs.data.jobs.length} jobs`);

              // ç‰¹å®šã®Issueç•ªå·ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®Issueã®ã¿ãƒªãƒˆãƒ©ã‚¤
              if (issueNumber && !workflow.head_commit.message.includes(`#${issueNumber}`)) {
                console.log(`Skipping workflow #${workflow.id} (not Issue #${issueNumber})`);
                continue;
              }

              // 1æ™‚é–“ä»¥å†…ã«å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã¿ãƒªãƒˆãƒ©ã‚¤ï¼ˆé »ç¹ã™ãã‚‹å†å®Ÿè¡Œã‚’é˜²ãï¼‰
              const failedAt = new Date(workflow.updated_at);
              const now = new Date();
              const hoursSinceFailure = (now - failedAt) / (1000 * 60 * 60);

              if (hoursSinceFailure > 1) {
                console.log(`Retrying workflow #${workflow.id} (failed ${Math.floor(hoursSinceFailure)} hours ago)`);

                try {
                  await github.rest.actions.reRunWorkflow({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: workflow.id
                  });

                  console.log(`âœ… Successfully re-ran workflow #${workflow.id}`);

                  // ãƒªãƒˆãƒ©ã‚¤ã—ãŸã“ã¨ã‚’Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
                  // ï¼ˆIssueç•ªå·ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‹ã‚‰å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ã“ã“ã§ã¯çœç•¥ï¼‰
                  // å®Ÿè£…ã™ã‚‹å ´åˆã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰Issueç•ªå·ã‚’å–å¾—

                } catch (error) {
                  console.error(`âŒ Failed to re-run workflow #${workflow.id}:`, error.message);
                }
              } else {
                console.log(`Skipping workflow #${workflow.id} (failed only ${Math.floor(hoursSinceFailure * 60)} minutes ago, waiting for cooldown)`);
              }
            }

      - name: Summary
        run: |
          echo "ğŸ”„ Auto-retry check completed"
          echo "Next scheduled run: 30 minutes from now"
